<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealmForge - Fantasy Map Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=300">
</head>
<body>
    <!-- Cartography Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-bg">
            <div class="parchment-base"></div>
            <div class="parchment-texture"></div>
            <div class="parchment-noise"></div>
            <div class="parchment-fibers"></div>
            <div class="film-grain"></div>
            <div class="scanlines"></div>
            <div class="parchment-vignette"></div>
            
            <!-- Simple decorative border -->
            <div class="map-border">
                <div class="border-corner tl"></div>
                <div class="border-corner tr"></div>
                <div class="border-corner bl"></div>
                <div class="border-corner br"></div>
            </div>
        </div>
        
        <div class="loading-content">
            <!-- Compass Rose -->
            <div class="compass-container">
                <svg viewBox="0 0 200 200" class="compass-rose">
                    <!-- Outer rings -->
                    <circle cx="100" cy="100" r="95" fill="none" stroke="#5a4a3a" stroke-width="2"/>
                    <circle cx="100" cy="100" r="88" fill="none" stroke="#7a6a5a" stroke-width="1" stroke-dasharray="3,3"/>
                    <circle cx="100" cy="100" r="80" fill="none" stroke="#5a4a3a" stroke-width="1.5"/>
                    
                    <!-- Degree ticks -->
                    <g stroke="#5a4a3a" stroke-width="1.5">
                        <line x1="100" y1="5" x2="100" y2="15"/>
                        <line x1="100" y1="185" x2="100" y2="195"/>
                        <line x1="5" y1="100" x2="15" y2="100"/>
                        <line x1="185" y1="100" x2="195" y2="100"/>
                    </g>
                    <g stroke="#7a6a5a" stroke-width="1">
                        <line x1="100" y1="5" x2="100" y2="12" transform="rotate(45,100,100)"/>
                        <line x1="100" y1="5" x2="100" y2="12" transform="rotate(135,100,100)"/>
                        <line x1="100" y1="5" x2="100" y2="12" transform="rotate(225,100,100)"/>
                        <line x1="100" y1="5" x2="100" y2="12" transform="rotate(315,100,100)"/>
                    </g>
                    
                    <!-- Cardinal letters -->
                    <text x="100" y="32" class="cardinal-letter">N</text>
                    <text x="100" y="178" class="cardinal-letter">S</text>
                    <text x="22" y="104" class="cardinal-letter">W</text>
                    <text x="178" y="104" class="cardinal-letter">E</text>
                    
                    <!-- Main star points -->
                    <!-- North - Red -->
                    <polygon points="100,22 106,70 100,60 94,70" fill="#8b0000" stroke="#5a0000" stroke-width="1"/>
                    <!-- South -->
                    <polygon points="100,178 106,130 100,140 94,130" fill="#4a3a2a" stroke="#2a1a0a" stroke-width="1"/>
                    <!-- East -->
                    <polygon points="178,100 130,106 140,100 130,94" fill="#4a3a2a" stroke="#2a1a0a" stroke-width="1"/>
                    <!-- West -->
                    <polygon points="22,100 70,106 60,100 70,94" fill="#4a3a2a" stroke="#2a1a0a" stroke-width="1"/>
                    
                    <!-- Diagonal points -->
                    <polygon points="100,35 104,65 100,58 96,65" fill="#6a5a4a" stroke="#4a3a2a" stroke-width="0.5" transform="rotate(45,100,100)"/>
                    <polygon points="100,35 104,65 100,58 96,65" fill="#6a5a4a" stroke="#4a3a2a" stroke-width="0.5" transform="rotate(135,100,100)"/>
                    <polygon points="100,35 104,65 100,58 96,65" fill="#6a5a4a" stroke="#4a3a2a" stroke-width="0.5" transform="rotate(225,100,100)"/>
                    <polygon points="100,35 104,65 100,58 96,65" fill="#6a5a4a" stroke="#4a3a2a" stroke-width="0.5" transform="rotate(315,100,100)"/>
                    
                    <!-- Center -->
                    <circle cx="100" cy="100" r="15" fill="#d4c4a8" stroke="#5a4a3a" stroke-width="2"/>
                    <circle cx="100" cy="100" r="8" fill="#c4b393" stroke="#6a5a4a" stroke-width="1"/>
                    <circle cx="100" cy="100" r="4" fill="#4a3a2a"/>
                </svg>
            </div>
            
            <!-- Title area -->
            <div class="title-area">
                <div class="title-ornament top">✦ ─────── ✦</div>
                <h1 class="loading-title">RealmForge</h1>
                <p class="loading-subtitle">Cartographer's Workshop</p>
                <div class="title-ornament bottom">✦ ─────── ✦</div>
            </div>
            
            <!-- Progress -->
            <div class="loading-progress">
                <div class="progress-container">
                    <span class="scale-mark">0</span>
                    <div class="progress-track">
                        <div class="progress-fill" id="loading-progress"></div>
                    </div>
                    <span class="scale-mark">100 leagues</span>
                </div>
                <span class="loading-status" id="loading-status">Preparing parchment...</span>
            </div>
            
            <!-- Flavor -->
            <div class="loading-flavor">
                <span class="flavor-deco">~</span>
                <span class="flavor-text">Here be dragons</span>
                <span class="flavor-deco">~</span>
            </div>
        </div>
    </div>

    <div class="app">
        <!-- Header Bar -->
        <header class="topbar">
            <div class="brand">
                <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polygon points="12,2 22,8.5 22,15.5 12,22 2,15.5 2,8.5"/>
                    <line x1="12" y1="22" x2="12" y2="15.5"/>
                    <polyline points="22,8.5 12,15.5 2,8.5"/>
                </svg>
                <span class="brand-name">RealmForge</span>
            </div>
            <div class="topbar-controls">
                <div class="view-switcher">
                    <select id="render-mode">
                        <option value="political" selected>Political Map</option>
                        <option value="terrain">Terrain</option>
                        <option value="heightmap">Heightmap</option>
                        <option value="precipitation">Precipitation</option>
                    </select>
                </div>
                <div class="zoom-widget">
                    <button class="icon-btn" id="zoom-out" title="Zoom Out">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <span class="zoom-display" id="zoom-level">100%</span>
                    <button class="icon-btn" id="zoom-in" title="Zoom In">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <button class="icon-btn" id="zoom-reset" title="Reset View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    </button>
                </div>
                <button class="action-btn primary" id="generate-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v3m0 12v3M3 12h3m12 0h3m-2.6-6.4l-2.1 2.1m-8.6 8.6l-2.1 2.1m0-12.8l2.1 2.1m8.6 8.6l2.1 2.1"/></svg>
                    Generate World
                </button>
            </div>
        </header>

        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Generate Button at top -->
                <div class="sidebar-header">
                    <button class="generate-main-btn" id="generate-btn-sidebar">
                        <svg viewBox="0 0 24 24"><path d="M12 3v3m0 12v3M3 12h3m12 0h3m-2.6-6.4l-2.1 2.1m-8.6 8.6l-2.1 2.1m0-12.8l2.1 2.1m8.6 8.6l2.1 2.1"/></svg>
                        New World
                    </button>
                </div>

                <div class="sidebar-scroll">
                    <!-- Seed & Basic -->
                    <div class="ctrl-group">
                        <div class="ctrl-row">
                            <span class="ctrl-label">Seed</span>
                            <div class="ctrl-input-wrap">
                                <input type="number" id="seed" value="12345" class="ctrl-input">
                                <button class="ctrl-icon-btn" id="random-seed" title="Randomize">
                                    <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="ctrl-row">
                            <span class="ctrl-label">Cells</span>
                            <input type="number" id="cell-count" value="50000" min="100" max="100000" step="1000" class="ctrl-input">
                        </div>
                        <div class="ctrl-row">
                            <span class="ctrl-label">Layout</span>
                            <select id="distribution" class="ctrl-select">
                                <option value="random">Random</option>
                                <option value="jittered" selected>Jittered</option>
                                <option value="poisson">Poisson</option>
                                <option value="relaxed">Relaxed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Terrain -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head">
                            <span>Terrain</span>
                            <button class="ctrl-action-btn" id="generate-heightmap-btn">Regenerate</button>
                        </div>
                        <div class="ctrl-row">
                            <span class="ctrl-label">Type</span>
                            <select id="noise-algorithm" class="ctrl-select">
                                <option value="continental" selected>Continental</option>
                                <option value="eroded">Eroded</option>
                                <option value="multiwarp">Warped</option>
                                <option value="swiss">Hills</option>
                                <option value="valleys">Valleys</option>
                                <option value="terraced">Plateaus</option>
                                <option value="ridged">Ridges</option>
                                <option value="fbm">FBM</option>
                            </select>
                        </div>
                        <div class="ctrl-slider">
                            <span>Scale</span>
                            <input type="range" id="noise-frequency" min="0.5" max="8" step="0.1" value="3">
                            <span class="ctrl-val" id="noise-frequency-value">3.0</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Detail</span>
                            <input type="range" id="noise-octaves" min="1" max="8" step="1" value="6">
                            <span class="ctrl-val" id="noise-octaves-value">6</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Sea Level</span>
                            <input type="range" id="sea-level" min="0" max="0.8" step="0.01" value="0.4">
                            <span class="ctrl-val" id="sea-level-value">0.40</span>
                        </div>
                        <div class="ctrl-row">
                            <span class="ctrl-label">Edge</span>
                            <select id="falloff-type" class="ctrl-select">
                                <option value="none">None</option>
                                <option value="radial" selected>Island</option>
                                <option value="square">Square</option>
                            </select>
                        </div>
                        <div class="ctrl-slider">
                            <span>Falloff</span>
                            <input type="range" id="falloff-strength" min="0" max="1" step="0.05" value="0.7">
                            <span class="ctrl-val" id="falloff-strength-value">0.70</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Smooth</span>
                            <input type="range" id="smoothing" min="0" max="10" step="1" value="0">
                            <span class="ctrl-val" id="smoothing-value">0</span>
                        </div>
                        <div class="ctrl-slider" style="display:none">
                            <span>Str</span>
                            <input type="range" id="smoothing-strength" min="0" max="1" step="0.05" value="0.6">
                            <span class="ctrl-val" id="smoothing-strength-value">0.60</span>
                        </div>
                    </div>

                    <!-- Erosion -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head">
                            <span>Erosion</span>
                            <button class="ctrl-action-btn" id="apply-erosion-btn">Apply</button>
                        </div>
                        <div class="ctrl-slider">
                            <span>Iterations</span>
                            <input type="range" id="erosion-iterations" min="10000" max="200000" step="10000" value="200000">
                            <span class="ctrl-val" id="erosion-iterations-value">200k</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Strength</span>
                            <input type="range" id="erosion-strength" min="0.1" max="1.0" step="0.05" value="1.0">
                            <span class="ctrl-val" id="erosion-strength-value">1.00</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Valleys</span>
                            <input type="range" id="deposition-rate" min="0.1" max="0.8" step="0.05" value="0.6">
                            <span class="ctrl-val" id="deposition-rate-value">0.60</span>
                        </div>
                    </div>

                    <!-- Climate -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head">
                            <span>Climate</span>
                            <div class="ctrl-action-group">
                                <button class="ctrl-action-btn" id="generate-precip-btn">Rain</button>
                                <button class="ctrl-action-btn" id="generate-rivers-btn">Rivers</button>
                            </div>
                        </div>
                        <div class="ctrl-row">
                            <span class="ctrl-label">Wind</span>
                            <select id="wind-direction" class="ctrl-select">
                                <option value="0">N ↓</option>
                                <option value="45">NE ↙</option>
                                <option value="90">E ←</option>
                                <option value="135">SE ↖</option>
                                <option value="180">S ↑</option>
                                <option value="225">SW ↗</option>
                                <option value="270" selected>W →</option>
                                <option value="315">NW ↘</option>
                            </select>
                        </div>
                        <div class="ctrl-slider">
                            <span>Strength</span>
                            <input type="range" id="wind-strength" min="0.1" max="1" step="0.1" value="0.8">
                            <span class="ctrl-val" id="wind-strength-value">0.80</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Rivers</span>
                            <input type="range" id="num-rivers" min="5" max="100" step="5" value="30">
                            <span class="ctrl-val" id="num-rivers-value">30</span>
                        </div>
                        <label class="ctrl-check">
                            <input type="checkbox" id="show-rivers" checked>
                            <span>Show Rivers</span>
                        </label>
                    </div>

                    <!-- Nations -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head">
                            <span>Nations</span>
                            <button class="ctrl-action-btn" id="generate-kingdoms-btn">Generate</button>
                        </div>
                        <div class="ctrl-slider">
                            <span>Kingdoms</span>
                            <input type="range" id="num-kingdoms" min="3" max="30" step="1" value="12">
                            <span class="ctrl-val" id="num-kingdoms-value">12</span>
                        </div>
                        <div class="ctrl-slider">
                            <span>Settlements</span>
                            <input type="range" id="road-density" min="0" max="10" step="1" value="7">
                            <span class="ctrl-val" id="road-density-value">7</span>
                        </div>
                    </div>

                    <!-- Display -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head"><span>Display</span></div>
                        <div class="ctrl-slider">
                            <span>Contours</span>
                            <input type="range" id="subdivision" min="0" max="4" step="1" value="2">
                            <span class="ctrl-val" id="subdivision-value">2</span>
                        </div>
                        <div class="ctrl-checks">
                            <label class="ctrl-check">
                                <input type="checkbox" id="show-edges" checked>
                                <span>Edges</span>
                            </label>
                            <label class="ctrl-check">
                                <input type="checkbox" id="show-centers">
                                <span>Centers</span>
                            </label>
                            <label class="ctrl-check">
                                <input type="checkbox" id="show-delaunay">
                                <span>Mesh</span>
                            </label>
                            <label class="ctrl-check">
                                <input type="checkbox" id="show-windrose">
                                <span>Compass Rose</span>
                            </label>
                            <label class="ctrl-check">
                                <input type="checkbox" id="show-grid" checked>
                                <span>Coordinate Grid</span>
                            </label>
                            <label class="ctrl-check">
                                <input type="checkbox" id="show-scale" checked>
                                <span>Scale Bar</span>
                            </label>
                        </div>
                    </div>

                    <!-- Map Scale -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head"><span>Map Scale</span></div>
                        <label class="ctrl-row">
                            <span>World Size (km)</span>
                            <input type="range" id="world-size-km" min="100" max="5000" value="1000" step="100">
                            <span class="ctrl-value" id="world-size-km-val">1000</span>
                        </label>
                    </div>

                    <!-- Export -->
                    <div class="ctrl-section">
                        <div class="ctrl-section-head"><span>Export</span></div>
                        <div class="ctrl-export-row">
                            <button class="ctrl-export-btn" id="export-png">
                                <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                PNG
                            </button>
                            <button class="ctrl-export-btn" id="export-json">
                                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                                JSON
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Footer -->
                <div class="sidebar-footer">
                    <div class="stats-bar">
                        <span><b id="stat-cells">0</b> cells</span>
                        <span><b id="stat-land">0%</b> land</span>
                        <span><b id="stat-gen-time">0</b>ms</span>
                    </div>
                    <span id="stat-visible" style="display:none">0</span>
                    <span id="stat-render-time" style="display:none">0</span>
                </div>
            </aside>

            <!-- Canvas -->
            <main class="canvas-area">
                <canvas id="voronoi-canvas"></canvas>
                <canvas id="heightmap-overlay"></canvas>
                <svg id="river-svg" class="map-svg"></svg>
                <svg id="kingdom-svg" class="map-svg"></svg>
                <svg id="road-svg" class="map-svg"></svg>
                <svg id="city-svg" class="map-svg"></svg>
                <svg id="label-svg" class="map-svg"></svg>
                <div id="cell-tooltip" class="cell-tooltip"></div>
                
                <!-- Info Panel (click to show) -->
                <div id="info-panel" class="info-panel">
                    <button class="info-panel-close" id="info-panel-close">&times;</button>
                    <div class="info-panel-content" id="info-panel-content"></div>
                </div>
                
                <!-- Overlay toggle buttons -->
                <div class="overlay-toggles">
                    <button class="overlay-toggle-btn" id="toggle-heightmap" title="Toggle Heightmap Overlay">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 3l4 8 5-5 5 15H2L8 3z"/>
                        </svg>
                        <span>Elevation</span>
                    </button>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-contour@4"></script>
    
    <!-- Loading Progress -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Progress bar updates based on loading status
        const progressFill = document.getElementById('loading-progress');
        const statusEl = document.getElementById('loading-status');
        const progressMap = {
            'Initializing': 5,
            'Generating cells': 15,
            'Creating terrain': 35,
            'Simulating climate': 55,
            'Carving rivers': 70,
            'Forming kingdoms': 85,
            'Rendering': 95
        };
        
        // Observe status text changes
        const observer = new MutationObserver(() => {
            const status = statusEl.textContent;
            const progress = progressMap[status] || 0;
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
        });
        
        if (statusEl) {
            observer.observe(statusEl, { childList: true, characterData: true, subtree: true });
        }
    });
    </script>
    
    <script type="module" src="app.js?v=300"></script>
</body>
</html>
